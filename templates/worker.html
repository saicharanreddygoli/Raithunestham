<!DOCTYPE html>
<html lang="{{ lang or 'en' }}">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>AgriConnect · Worker</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#4CAF50",
                        "primary-dark": "#388E3C",
                        "background-light": "#F5F5F5",
                        "background-dark": "#1a1a1a",
                        secondary: "#8D6E63",
                        accent: "#FFC107"
                    },
                    fontFamily: {
                        display: ["Public Sans", "Noto Sans Telugu", "sans-serif"]
                    },
                    borderRadius: {
                        DEFAULT: "0.5rem",
                        lg: "0.75rem",
                        xl: "1rem",
                        full: "9999px"
                    }
                }
            }
        };
    </script>
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        body {
            min-height: 100vh;
        }
    </style>
</head>
<body class="bg-background-light font-display text-[#333333] dark:bg-background-dark dark:text-gray-200">
    <div class="flex min-h-screen flex-col">
        <header class="flex items-center justify-between border-b border-gray-200 bg-white px-4 py-4 shadow-sm dark:border-gray-700 dark:bg-background-dark">
            <div>
                <p class="text-xs uppercase tracking-[0.4em] text-gray-500 dark:text-gray-400">AgriConnect</p>
                <h1 class="text-2xl font-bold leading-tight text-[#333333] dark:text-gray-100">Hello, {{ worker.name }}! / హలో {{ worker.name }}!</h1>
                <p class="text-sm text-gray-500 dark:text-gray-400">Find your next job today. / మీ తదుపరి పనిని ఈరోజే కనుగొనండి.</p>
            </div>
            <div class="flex items-center gap-3">
                <div class="hidden rounded-xl bg-white px-4 py-2 text-sm font-medium text-gray-600 shadow dark:bg-gray-800 dark:text-gray-200 sm:block">
                    <div class="flex items-center gap-2">
                        <span class="material-symbols-outlined text-base text-primary">location_on</span>
                        <span>{{ worker.location }} · స్థానం</span>
                    </div>
                </div>
                <a href="/logout" class="flex h-12 w-12 items-center justify-center rounded-full bg-gray-200 text-[#333333] transition hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-200">
                    <span class="material-symbols-outlined text-2xl">logout</span>
                </a>
            </div>
        </header>

        <main class="flex-1 pb-24">
            <section class="space-y-6 px-4 py-6">
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, msg in messages %}
                            <div class="rounded-xl border border-primary/20 bg-white/90 p-4 text-sm text-[#333333] shadow dark:border-primary/30 dark:bg-gray-800 dark:text-gray-100">
                                <div class="flex items-start gap-3">
                                    <span class="material-symbols-outlined text-primary">info</span>
                                    <div>
                                        <p class="font-semibold text-primary">{{ category|capitalize }}</p>
                                        <p class="mt-1">{{ msg }}</p>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
                {% if message %}
                    <div class="rounded-xl border border-primary/20 bg-white/90 p-4 text-sm text-[#333333] shadow dark:border-primary/30 dark:bg-gray-800 dark:text-gray-100">
                        <div class="flex items-start gap-3">
                            <span class="material-symbols-outlined text-primary">info</span>
                            <div>
                                <p class="font-semibold text-primary">{{ message_type|default('Notice')|capitalize }}</p>
                                <p class="mt-1">{{ message }}</p>
                            </div>
                        </div>
                    </div>
                {% endif %}

                <div class="flex flex-col gap-3 rounded-2xl bg-white p-4 shadow-sm dark:bg-gray-900">
                    <form method="POST" action="/worker" class="flex flex-col gap-3 md:flex-row">
                        <input type="hidden" name="action" value="fetch_tasks">
                        <label class="flex h-12 w-full flex-col">
                            <div class="flex h-full items-center overflow-hidden rounded-xl bg-gray-100 dark:bg-gray-800">
                                <span class="flex h-full w-12 items-center justify-center text-gray-400 dark:text-gray-500">
                                    <span class="material-symbols-outlined">search</span>
                                </span>
                                <span class="px-3 text-sm text-gray-500 dark:text-gray-400">{{ worker.village|capitalize }} · {{ worker.phone }}</span>
                            </div>
                        </label>
                        <button type="submit" class="flex h-12 shrink-0 items-center justify-center gap-2 rounded-xl bg-primary px-4 font-semibold text-white shadow hover:bg-primary-dark">
                            <span class="material-symbols-outlined text-white">refresh</span>
                            <span>Fetch Nearby Tasks / సమీప పనులను పొందండి</span>
                        </button>
                        <a href="{{ url_for('worker_help') }}" class="flex h-12 shrink-0 items-center justify-center gap-2 rounded-xl border border-primary px-4 font-semibold text-primary transition hover:bg-primary/10 dark:border-primary/60 dark:text-primary">
                            <span class="material-symbols-outlined text-primary">volunteer_activism</span>
                            <span>Ask Volunteer / సేవక సహాయం కోరండి</span>
                        </a>
                    </form>
                </div>

                <section class="space-y-4">
                    <div class="flex items-center justify-between">
                        <h2 class="text-xl font-semibold text-[#333333] dark:text-gray-100">Nearby Tasks / సమీప పనులు</h2>
                        <span class="text-xs uppercase tracking-[0.35em] text-gray-500 dark:text-gray-500">Updated daily / ప్రతి రోజు నవీకరణ</span>
                    </div>
                    {% if nearby_tasks %}
                        <div class="grid gap-4">
                            {% for task in nearby_tasks %}
                                <article class="flex flex-col gap-4 rounded-2xl bg-white p-5 shadow-sm transition hover:-translate-y-0.5 hover:shadow-lg dark:bg-gray-900">
                                    <header class="flex items-start justify-between gap-4">
                                        <div>
                                            <h3 class="text-lg font-semibold text-[#333333] dark:text-gray-100">{{ task.task }}</h3>
                                            <p class="text-sm text-gray-500 dark:text-gray-400">{{ task.location }}</p>
                                        </div>
                                        <div class="flex shrink-0 items-center gap-1.5 rounded-full bg-primary/10 px-3 py-1.5 text-primary dark:bg-primary/20">
                                            <span class="material-symbols-outlined !text-[18px]">currency_rupee</span>
                                            <p class="text-xs font-bold">₹{{ task.wage }}/day</p>
                                        </div>
                                    </header>
                                    <dl class="grid gap-2 text-sm text-gray-600 dark:text-gray-300 sm:grid-cols-2">
                                        <div class="flex items-center gap-1.5">
                                            <span class="material-symbols-outlined !text-base text-primary">location_on</span>
                                            <span>{{ task.distance_km if task.distance_km is not none else '—' }} km / కి.మీ దూరం</span>
                                        </div>
                                        <div class="flex items-center gap-1.5">
                                            <span class="material-symbols-outlined !text-base text-primary">group</span>
                                            <span>{{ task.num_workers }} workers needed / కావలసిన కార్మికులు</span>
                                        </div>
                                        <div class="flex items-center gap-1.5">
                                            <span class="material-symbols-outlined !text-base text-primary">calendar_today</span>
                                            <span>{{ task.created_at | timestamp_to_datetime }}</span>
                                        </div>
                                        <div class="flex items-center gap-1.5 sm:col-span-2">
                                            <span class="material-symbols-outlined !text-base text-primary">info</span>
                                            <span>{{ task.description or 'No description provided' }} / వివరణ లేదు</span>
                                        </div>
                                    </dl>
                                    <div class="flex flex-wrap gap-3 pt-2">
                                        {% set task_village = task.village if task.village else (task.location.split(',')[0] if task.location else '') %}
                                        <a href="{{ url_for('worker_help', village=(task_village or '')|lower, task_name=task.task, task_wage=task.wage, task_location=task.location, task_id=task._id|string) }}"
                                           class="inline-flex items-center gap-2 rounded-xl border border-primary px-4 py-2 text-sm font-semibold text-primary transition hover:bg-primary/10 dark:border-primary/60 dark:text-primary">
                                            <span class="material-symbols-outlined !text-base">support_agent</span>
                                            <span>Need Volunteer Help / సేవక సహాయం కావాలి</span>
                                        </a>
                                        <form method="POST" action="/worker">
                                            <input type="hidden" name="task_id" value="{{ task._id|string }}">
                                            <button name="action" value="accept" type="submit"
                                                    class="inline-flex items-center gap-2 rounded-xl bg-primary px-4 py-2 text-sm font-semibold text-white shadow hover:bg-primary-dark">
                                                <span class="material-symbols-outlined !text-base text-white">check_circle</span>
                                                <span>Accept Task / పని అంగీకరించండి</span>
                                            </button>
                                        </form>
                                        <form method="POST" action="/worker">
                                            <input type="hidden" name="task_id" value="{{ task._id|string }}">
                                            <button name="action" value="deny" type="submit"
                                                    class="inline-flex items-center gap-2 rounded-xl border border-red-500 px-4 py-2 text-sm font-semibold text-red-500 transition hover:bg-red-50 dark:border-red-400 dark:text-red-300">
                                                <span class="material-symbols-outlined !text-base">cancel</span>
                                                <span>Deny / తిరస్కరించండి</span>
                                            </button>
                                        </form>
                                    </div>
                                </article>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="rounded-2xl border border-dashed border-primary/30 bg-white p-6 text-center text-sm text-gray-500 shadow dark:border-primary/40 dark:bg-gray-900 dark:text-gray-300">
                            No nearby tasks yet. Fetch again in a few minutes or reach out to a volunteer. / సమీప పనులు లేవు. కొద్దిసేపటి తర్వాత మళ్లీ ప్రయత్నించండి లేదా సేవకుని సంప్రదించండి.
                        </div>
                    {% endif %}
                </section>

                {% if latest_messages %}
                <section class="space-y-4">
                    <div class="flex items-center justify-between">
                        <h2 class="text-xl font-semibold text-[#333333] dark:text-gray-100">Volunteer Messages / సేవకుల సందేశాలు</h2>
                        <span class="text-xs uppercase tracking-[0.35em] text-gray-500 dark:text-gray-500">English • తెలుగు</span>
                    </div>
                    <div class="grid gap-4">
                        {% for msg in latest_messages %}
                            <article class="rounded-2xl bg-white p-5 shadow-sm transition hover:-translate-y-0.5 hover:shadow-lg dark:bg-gray-900">
                                <header class="flex items-start justify-between gap-3">
                                    <div>
                                        <h3 class="text-sm font-semibold text-primary">{{ (msg.message_en|default('')).split('\n')[0] or 'Volunteer update' }}</h3>
                                        <time class="text-xs text-gray-500 dark:text-gray-400">{{ msg.created_at | timestamp_to_datetime }}</time>
                                    </div>
                                    <form method="POST" action="/worker" class="shrink-0">
                                        <input type="hidden" name="action" value="delete_notification">
                                        <input type="hidden" name="notification_id" value="{{ msg._id|string }}">
                                        <button type="submit" class="inline-flex h-8 w-8 items-center justify-center rounded-full border border-red-200 text-red-500 transition hover:bg-red-50 dark:border-red-400/40 dark:text-red-300 dark:hover:bg-red-500/10" title="Delete notification / నోటిఫికేషన్ తొలగించండి">
                                            <span class="material-symbols-outlined text-base">delete</span>
                                        </button>
                                    </form>
                                </header>
                                <div class="mt-3 grid gap-2 text-sm">
                                    {% if msg.message_en %}
                                        <pre class="whitespace-pre-wrap rounded-xl bg-gray-100 p-3 text-[#333333] dark:bg-gray-800 dark:text-gray-100">{{ msg.message_en }}</pre>
                                    {% endif %}
                                    {% if msg.message_te %}
                                        <pre class="whitespace-pre-wrap rounded-xl bg-primary/10 p-3 text-primary dark:bg-primary/20">{{ msg.message_te }}</pre>
                                    {% endif %}
                                </div>
                                {% if msg.volunteer_phone %}
                                    <a href="tel:{{ msg.volunteer_phone }}" class="mt-3 inline-flex items-center gap-2 rounded-xl bg-primary px-4 py-2 text-sm font-semibold text-white shadow hover:bg-primary-dark">
                                        <span class="material-symbols-outlined !text-base text-white">call</span>
                                        <span>Call Volunteer / సేవకునికి కాల్ చేయండి</span>
                                    </a>
                                {% endif %}
                            </article>
                        {% endfor %}
                    </div>
                </section>
                {% endif %}

                <section class="space-y-4">
                    <div class="flex items-center justify-between">
                        <h2 class="text-xl font-semibold text-[#333333] dark:text-gray-100">Accepted Tasks</h2>
                        <span class="text-xs uppercase tracking-[0.35em] text-gray-500 dark:text-gray-500">Progress / పురోగతి</span>
                    </div>
                    {% if accepted_tasks %}
                        <div class="grid gap-4">
                            {% for task in accepted_tasks %}
                                <article class="rounded-2xl bg-white p-5 shadow-sm dark:bg-gray-900">
                                    <header class="flex items-start justify-between gap-4">
                                        <div>
                                            <h3 class="text-lg font-semibold text-[#333333] dark:text-gray-100">{{ task.task }}</h3>
                                            <p class="text-sm text-gray-500 dark:text-gray-400">{{ task.location }}</p>
                                        </div>
                                        <span class="inline-flex items-center gap-1.5 rounded-full {{ 'bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-200' if task.completed else 'bg-accent/10 text-accent dark:bg-accent/20' }} px-3 py-1 text-xs font-semibold uppercase tracking-wide">
                                            {{ 'Completed' if task.completed else 'In Progress' }}
                                        </span>
                                    </header>
                                    <dl class="mt-3 grid gap-2 text-sm text-gray-600 dark:text-gray-300 sm:grid-cols-2">
                                        <div class="flex items-center gap-1.5">
                                            <span class="material-symbols-outlined !text-base text-primary">group</span>
                                            <span>{{ task.num_workers }} workers / కార్మికులు</span>
                                        </div>
                                        <div class="flex items-center gap-1.5">
                                            <span class="material-symbols-outlined !text-base text-primary">currency_rupee</span>
                                            <span>₹{{ task.wage }} / day · రోజుకు</span>
                                        </div>
                                        <div class="flex items-center gap-1.5">
                                            <span class="material-symbols-outlined !text-base text-primary">badge</span>
                                            <span>{{ task.accepter_name }}</span>
                                        </div>
                                        <div class="flex items-center gap-1.5">
                                            <span class="material-symbols-outlined !text-base text-primary">schedule</span>
                                            <span>{{ task.created_at | timestamp_to_datetime }}</span>
                                        </div>
                                    </dl>
                                    {% if not task.completed %}
                                        <form method="POST" action="/worker" class="mt-4">
                                            <input type="hidden" name="task_id" value="{{ task._id|string }}">
                                            <button name="action" value="complete" type="submit"
                                                    class="inline-flex items-center gap-2 rounded-xl bg-primary px-4 py-2 text-sm font-semibold text-white shadow hover:bg-primary-dark">
                                            <span class="material-symbols-outlined !text-base text-white">task_alt</span>
                                            <span>Mark as Complete / పూర్తయిందిగా గుర్తించండి</span>
                                            </button>
                                        </form>
                                    {% endif %}
                                </article>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="rounded-2xl border border-dashed border-primary/30 bg-white p-6 text-center text-sm text-gray-500 shadow dark:border-primary/40 dark:bg-gray-900 dark:text-gray-300">
                            You have not accepted any tasks yet. / మీరు ఇంకా ఏ పనినీ అంగీకరించలేదు.
                        </div>
                    {% endif %}
                </section>
            </section>
        </main>
    </div>
</body>
</html>
